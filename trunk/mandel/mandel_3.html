<html>
<head>
    <title>Mandelbrot Set (fractional iteration count)</title>
    <script>
var N = 512;
var RANGE = [-2, 2];
var ESC_RADIUS = 20;
var LOG2 = Math.log(2);
var canvas = null;
var ctx = null;
    
var step = (function() {
    
    var complexPlane = (function() {
        var ret = [];
        var dx, dy;
        dx = dy = (RANGE[1] - RANGE[0]) / N;
        var c = [RANGE[0], RANGE[0]];
        for (var j = 0; j < N; j++) {
            c[0] = RANGE[0];
            for (var i = 0; i < N; i++) {
                ret[i + j * N] = {
                    'c': [c[0], c[1]],
                    'z': [0, 0],
                    'it': 0
                };
                c[0] += dx;
            }
            c[1] += dy;
        }
        return ret;
    })();

    function f(z, c) {
        return [z[0] * z[0] - z[1] * z[1] + c[0], 2 * z[0] * z[1] + c[1]];
    }
    
    function abs(z) {
        return Math.sqrt(z[0] * z[0] + z[1] * z[1]);
    }
    
    function getColor(cpe, out) {
        if (out) {
            /* fractional iterations calculation */
            var zmod = Math.sqrt(cpe.z[0] * cpe.z[0] + cpe.z[1] * cpe.z[1]);
            var iter = cpe.it + 1 - Math.log(Math.log(zmod)) / LOG2;
            /* 1 iter -> l = 0
               inf iters -> l = 255
               Let's use
               l = 255 - 255 / iters */
            var l = 255 - 255 / iter;
            return [l, l, l];
        } else {
            return [0, 0, 0];
        }
    }
    
    function walkCanvas() {
        var imd = ctx.getImageData(0, 0, N, N);
        var cpa = imd.data;
        
        var idx1, idx2;
        idx1 = idx2 = 0;
        for (var i = 0; i < N * N; i++) {
            var cpe = complexPlane[idx2];
            var out = abs(cpe.z) > ESC_RADIUS;
            if (!out) {
                cpe.z = f(cpe.z, cpe.c);
                cpe.it++;
            }
            idx2++;
            var color = getColor(cpe, out);
            cpa[idx1++] = color[0];
            cpa[idx1++] = color[1];
            cpa[idx1++] = color[2];
            cpa[idx1++] = 255;
        }
        
        ctx.putImageData(imd, 0, 0);
    }
    
    return walkCanvas;
})();

function start() {
    canvas = document.getElementById('main_canvas');
    ctx = canvas.getContext('2d');
    ctx.fillStyle = '#fff';
	ctx.fillRect(0, 0, N, N);
    
    setInterval(step, 100);
}
    </script>
</head>
<body onload="start()">
    <canvas id="main_canvas" width="512" height="512">
</body>
</html>